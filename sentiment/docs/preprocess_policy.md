# Cleaning & Normalization Policy (Правила препроцесингу)

Цей документ описує етапи очищення, нормалізації, маскування конфіденційних даних та розумного розбиття на речення для пайплайну обробки текстових даних.

## 1. Що очищаємо (Cleaning)
* **HTML-артефакти:** Декодуємо HTML-сутності (наприклад, `&quot;` перетворюється на `"`).
* **Технічні слова-артефакти:** Видаляємо сміттєві слова, що залишилися від парсингу веб-сторінок: *«розгорнути», «згорнути», «читати далі», «відповідь», «розгорнутим»*.
* **Зайві пробіли:** Замінюємо множинні пробіли, табуляції та переноси рядків на один одинарний пробіл. Видаляємо пробіли на початку та в кінці тексту.

## 2. Що нормалізуємо (Normalization)
* **Гомогліфи:** Замінюємо латинські літери, які візуально ідентичні кириличним (напр., латинські `a, e, i, o, p, x, y, c, M, T` тощо), на їхні правильні українські аналоги.
* **Апострофи:** Зводимо всі можливі типографські варіації апострофів (` ` `, `’`, `‘`) до єдиного стандартного машинного символу `'`.
* **Регістр (Caps Lock):** Слова, що складаються з 2 і більше ВЕЛИКИХ літер, примусово переводимо в нижній регістр (щоб емоційні коментарі не сприймалися як окремі сутності).
* **Пунктуація:**  Видаляємо пробіли *перед* розділовими знаками (`. , ! ?`).
  * Стискаємо надмірні емоційні знаки: `!!!` -> `!!`, `???` -> `??`, `.....` -> `...`.
* **Інтервали (Пробіли):**  Додаємо пробіл після скорочень адрес/типів населених пунктів (напр., `м.Київ` -> `м. Київ`, `вул.Шевченка` -> `вул. Шевченка`).
  * Відділяємо числа від одиниць виміру та валют, переводимо одиниці в нижній регістр (напр., `100грн` -> `100 грн`, `64GB` -> `64 gb`).

## 3. Що маскуємо (PII Masking)
Для збереження конфіденційності користувачів ми приховуємо чутливі дані за допомогою спеціальних тегів:
* **`<EMAIL>`**: Усі email-адреси.
* **`<URL>`**: Посилання на веб-сайти (http/https, www, домени .com, .ua тощо).
* **`<PHONE>`**: Українські номери телефонів у будь-яких форматах (з кодом +38, дужками, дефісами чи пробілами).
* **`<ID>`**: 
  * Номери замовлень, артикули, коди (ідентифікуються за словами "№", "код", "замовлення").
  * Будь-які довгі числа (від 5 до 15 цифр), які не є цінами або вагою (тобто після яких немає "грн", "usd", "шт" тощо).
  * *Примітка:* Якщо поруч стоїть кілька ідентифікаторів підряд (напр., `<ID>, <ID>`), вони зливаються в один тег `<ID>`, щоб не засмічувати текст.

## 4. Що НЕ чіпаємо (Preservation)
* **Коди моделей з цифрами:** Регулярний вираз для зняття Caps Lock ігнорує слова, які містять хоча б одну цифру. Тому назви на кшталт `LG42TV`, `KM3`, `B2B` залишаються без змін і не ламаються.
* **Абревіатури з 1 літери** та великі літери на початку речень залишаються великими.
* **Короткі числа:** Числа до 4 цифр (які зазвичай позначають ціни, роки, кількість) залишаються в тексті як є.

## 5. Розбиття на речення (Sentence Split)
Розбиття тексту на масив речень відбувається за допомогою кастомного RegEx-правила: `(?<!\b(?:{abbs_pattern}))(?<=[.!?])\s+(?=[А-ЯІЇЄҐA-Z])`. 

Цей підхід вирішує дві головні проблеми базового спліту:

1. **Захист від розриву на скороченнях (Negative Lookbehind):**
   Ми використовуємо попередньо визначений словник із 19 найпопулярніших українських загальноприйнятих скорочень: 
   `'ім.', 'вул.', 'грн.', 'обл.', 'р.', 'див.', 'п.', 'с.', 'м.', 'т.д.', 'т.п.', 'напр.', 'важ.', 'кг.', 'шт.', 'гр.', 'кв.', 'стор.', 'п.с.'`.
   Завдяки конструкції `(?<!\b...)` регулярний вираз перевіряє текст позаду крапки. Якщо перед крапкою стоїть слово з цього словника (наприклад, "м." або "т.д."), алгоритм **ігнорує** цю крапку і не розриває речення.

2. **Захист від розриву на числах та версіях (Positive Lookahead):**
   Дробові числа (`3.14`), дати (`01.12.2025`) або версії ПЗ (`1.2.3`) не розбиваються на окремі речення завдяки двом жорстким умовам:
   * Спліт відбувається **тільки** якщо після розділового знаку є щонайменше один пробіл (`\s+`). У числах і версіях пробілів після крапки немає.
   * Алгоритм дивиться вперед `(?=[А-ЯІЇЄҐA-Z])` і вимагає, щоб наступне слово обов'язково починалося з **Великої літери**. 

Таким чином, речення *"Я живу в м. Київ і використовую версію 3.14."* залишиться єдиним цілим елементом масиву.

---

## 6. Приклади "До / Після"

| Категорія | RAW (До) | PROCESSED (Після) |
| :--- | :--- | :--- |
| **HTML & Сміття** | `&quot;Товар супер&quot; читати далі` | `"Товар супер"` |
| **Гомогліфи** | `Купив в М0Y0` *(тут Y - латинська)* | `Купив в моуо` *(у - кирилична)* |
| **Апострофи** | `м’який комп\`ютер` | `м'який комп'ютер` |
| **Caps Lock** | `ЦЕ ПРОСТО ЖАХЛИВО` | `це просто жахливо` |
| **Caps Lock (Моделі)** | `Монітор DELL U2415` | `Монітор dell U2415` |
| **Пунктуація** | `Як так можна ! ? ! . . . . .` | `Як так можна!?...` |
| **Одиниці виміру** | `Пам'ять 64GB, ціна 1000грн` | `Пам'ять 64 gb, ціна 1000 грн` |
| **Адреси (Пробіли)** | `вул.Шевченка, м.Дніпро` | `вул. Шевченка, м. Дніпро` |
| **Маскування (Email)** | `Пишіть скарги на test-mail@ukr.net` | `Пишіть скарги на <EMAIL>` |
| **Маскування (URL)** | `Деталі тут: https://rozetka.ua/faq/` | `Деталі тут: <URL>` |
| **Маскування (Phone)**| `Дзвоніть +38(099)123-45-67` | `Дзвоніть <PHONE>` |
| **Маскування (ID)** | `Замовлення № 9876543 не прийшло` | `<ID> не прийшло` |
| **Маскування (ID)** | `Мій ТТН 20450123456789` | `Мій ТТН <ID>` |
| **Sentence Split** | `Клас! Ціна супер. Доставка в м. Київ.` | `["Клас!", "Ціна супер.", "Доставка в м. Київ."]` |
| **Sentence Split (Версії)**| `Оновив до 1.2.3. Працює чудово.` | `["Оновив до 1.2.3.", "Працює чудово."]` |